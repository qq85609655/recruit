var Genders = [{ code: 1, text: '男' }, { code: 2, text: '女'}];
var familyRelations = [{ code: 1, text: '父母' }, { code: 2, text: '配偶'}, { code: 3, text: '兄弟姐妹'}, { code: 4, text: '子女'}];
var emergentRelations=[{ code: 1, text: '父母' }, { code: 2, text: '配偶'}, { code: 3, text: '兄弟姐妹'}, { code: 4, text: '朋友'}, { code: 5, text: '其他亲戚'}, { code: 6, text: '其他'}];

// 获取一组checkbox的选中值,返回逗号分隔的字符串
function getCheckboxValue(Class) {
	var i=0,s = [];
	$(Class).each(function() {
		if($(this)[0].checked) {
			s[i++] = $(this).val();
		}
	});
	return s.join(",");
}

function getCheckboxText(Class) {
	var i=0,s = [];
	$(Class).each(function() {
		if($(this)[0].checked) {
			s[i++] = $(this).next().text();
		}
	});
	return s.join(",");
}

// 获取一组radio中的选中值 
function getRadioValue(Class) {
	var s;
	$(Class).each(function() {
		if($(this)[0].checked) {
			s = $(this).val();
		}
	});
	return s;
}

// 获取一组radio中的选中的label值 
function getRadioText(Class) {
	var s;
	$(Class).each(function() {
		if($(this)[0].checked) {
			s = $(this).next().text();
		}
	});
	return s;
}

// 设置一组radio的选中状态
function setRadioValue(Class,value) {
	$(Class).each(function() {
		if($(this).attr("value") == value) {
			this.checked = true;
		}
	});
}

// 获取select选中的值
function getSelectValue(Id) {
	return $(Id).find("option[value='" + $(Id).val() + "']").attr("id");
}

// 选中下拉列表中的某一项
function setSelectValue(id,value) {
	$(id).find("option[text='" + value + "']").attr("selected",true);
}

// 设置一组checkbox中的选中状态
function selectCheckbox(Class, values) {
	$(Class).each(function() {
		if(values[$(this).next().text()]) {
			$(this)[0].checked = true;
		}
	});
}

function ondrawcell(e) {
    switch (e.field){
		case "releaseDate":
			if(e.row.releaseDate != null){
				e.cellHtml = new Date(e.row.releaseDate).format("yyyy-MM-dd");
			}
     }  
}

function onValueChanged(e){
  var checked = this.getChecked();
//  alert(this.getValue());
}

//页面绑定事件调用
function bindingEvent(){
  //绑定国籍修改事件
  $("#nationality").change(function(){
    nationalityEvent();
  });
  //绑定招聘途径修改事件
  $(".recruitment-approach").change(function(){
    approachEvent();
  });
  //绑定是否有亲属在华星事件
  $(".relatives-flag").change(function(){
    relativesEvent();
  });
}

//国籍监听事件
function nationalityEvent(){
  var na = $("#nationality").val();
  if(na == '1'){
    $(".cnarea").css("display","table-row");
    //选择中国时证件关联为身份证
    $("#certificateType").val("1");
    
  }else{
    $(".cnarea").css("display","none");
    //台湾
    if(na == '2'){
      $("#certificateType").val("2");
    }
    else if(na == '3' || na == '4'){
      //港澳
      $("#certificateType").val("4");
    }else{
      //其他外国
      $("#certificateType").val("3");
    }
  }
}

//招聘途径修改事件
function approachEvent(e){
  var ap = $("input[name='recruitmentApproach']:checked").val();
  //内部推荐
  if(ap == '2'){
    $("#refereeArea").css("display","inline");
    $("#otherWayArea").css("display","none");
  }
  else if(ap == '4'){
    //其他途径
    $("#otherWayArea").css("display","inline");
    $("#refereeArea").css("display","none");
  }else{
    $("#refereeArea").css("display","none");
    $("#otherWayArea").css("display","none");
  }
}

//是否有亲属在华星事件
function relativesEvent(){
  var re = $("input[name='relativesFlag']:checked").val();
  if(re == '1'){
    $(".relativesArea").css("display","inline");
  }else{
    $(".relativesArea").css("display","none");
  }
  
}

//紧急联系人绑定事件
function emergentEvent(e){
  var grid = mini.get("datagrid-family");
  var grid2 = mini.get("datagrid-emergent");
  var emergentContacts = new Array();
  var familyData = grid.getData();
  for(var i = 0; i < familyData.length; i++) {
    var flag = familyData[i].emergentFlag
    //当前为紧急联系人时
    if(flag == '1' && emergentContacts.length<2){
      var emergent = new Object();
      emergent.emergentName = familyData[i].menberName;
      if(familyData[i].familyRelation == '4'){
        emergent.emergentRelation = '5';
      }else{
        emergent.emergentRelation = familyData[i].familyRelation;
      }
      emergent.emergentAddress = familyData[i].menberAddress;
      emergentContacts.push(emergent);
    }
  }
  var length=emergentContacts.length;
  for(var i=0;i<2-length;i++){
    var emergent = new Object();
    emergentContacts.push(emergent);
  }
  
  grid2.setData(emergentContacts);
}

//获取基本信息
function getBaseData() {
    return {
        id : $("#id").val(),
        personCode : $("#personCode").val(),
        recruiterNumber : $("#recruiterNumber").val(),
        recruiterName : $("#recruiterName").val(),
        nationality : $("#nationality").val(),
        cnname : $("#cnname").val(),
        enname : $("#enname").val(),
        sex : $("#sex").val(),
        maritalStatus : getRadioValue(".marital-status-interview"),
        namepy : $("#namepy").val(),
        nation : $("#nation").val(),
        politicalStatus : $("#politicalStatus").val(),
        nativePlace : $("#nativePlace").val(),
        residenceProperty : $("#residenceProperty").val(),
        residence : $("#residence").val(),
        certificateType : $("#certificateType").val(),
        certificateNum : $("#certificateNum").val(),
        birthdate : mini.get("birthdate").getFormValue(),
        highestEducation : $("#highestEducation").val(),
        phonenumber : $("#phonenumber").val(),
        email : $("#email").val(),
        address : $("#address").val(),
        postcodes : $("#postcodes").val(),
        startworkingdate : mini.get("startworkingdate").getFormValue(),
        positionName : $("#positionName").val(),
        arriveDate : mini.get("arriveDate").getFormValue(),
        expectedSalaryMonth : $("#expectedSalaryMonth").val(),
        expectedSalaryYear : $("#expectedSalaryYear").val(),
        expectedSalaryOther : $("#expectedSalaryOther").val(),
        recruitmentApproach : getRadioValue(".recruitment-approach"),
        refereeName : $("#refereeName").val(),
        otherWay : $("#otherWay").val(),
        relativesFlag : getRadioValue(".relatives-flag"),
        relativesName : $("#relativesName").val(),
        relativesShip : $("#relativesShip").val(),
    };
}

//获取家庭成员
function getFamilyData(){
    var json = mini.encode(mini.get("datagrid-family").getData(),"yyyy-MM-dd");
    return json;
}

//紧急联系人
function getEmergentData(){
  return mini.get("datagrid-emergent").getData(true);
}

//教育经历
function getEducationData(){
  var edus = new Array();
  for(var i = 1; i <= educount; i++) {
    var edu = new Object();
    edu["eduStartDate"] = mini.get("eduStartDate"+i).getFormValue();
    edu["eduEndDate"] = mini.get("eduEndDate"+i).getFormValue();
    edu["schoolName"] = $("#schoolName"+i).val();
    edu["major"] = $("#major"+i).val();
    edu["education"] = $("#education"+i).val();
    edu["eduType"] = $("#eduType"+i).val();
    edu["certificate"] = getCheckboxValue(".certificate"+i);
    if(edu["eduStartDate"]!=""&&edu["eduEndDate"]!=""){
      edus.push(edu);
    }
    
  }
  return edus;
}

//获得证书
function getCertificationData(){
  var certifications = new Array();
  
  for(var i = 1; i <= 2; i++) {
    var date=mini.get("diplomaDate"+i).getFormValue();
    if(date != ''){
      var certification = new Object();
      certification["type"] = $("#diplomaType"+i).val();
      certification["name"] = $("#diplomaName"+i).val();
      certification["receivingdate"] =  mini.get("diplomaDate"+i).getFormValue();
      certification["num"] = $("#diplomaNum"+i).val();
      certification["authorityOrg"] = $("#diplomaOrgan"+i).val();
      certifications.push(certification);
    }
  }
  return certifications;
}

//计算机与语言
function getLanguageData(){
  var language = new Object();
  language["officeFlag"] = mini.get("officeFlag").getValue();
  language["officeSkilledLevel"] = getRadioValue(".officeSkilledLevel");
  language["officeDiploma"] = $(".officeDiploma").val();
  
  language["englishFlag"] = mini.get("englishFlag").getValue();
  language["officeSkilledLevel"] = getRadioValue(".officeSkilledLevel");
  language["englishDiploma"] = $("#englishDiploma").val();

  language["sapFlag"] = mini.get("sapFlag").getValue();
  language["sapSkilledLevel"] = getRadioValue(".sapSkilledLevel");
  language["sapDiploma"] = $("#sapDiploma").val();

  language["koreanFlag"] = mini.get("koreanFlag").getValue();
  language["koreanSkilledLevel"] = getRadioValue(".koreanSkilledLevel");
  language["koreanDiploma"] = $("#koreanDiploma").val();

  language["vbaFlag"] = mini.get("vbaFlag").getValue();
  language["vbaSkilledLevel"] = getRadioValue(".vbaSkilledLevel");
  language["vbaDiploma"] = $("#vbaDiploma").val();

  language["japaneseFlag"] = mini.get("japaneseFlag").getValue();
  language["japaneseSkilledLevel"] = getRadioValue(".japaneseSkilledLevel");
  language["japaneseDiploma"] = $("#japaneseDiploma").val();

  language["otheritFlag"] = mini.get("otheritFlag").getValue();
  language["otheritSkilledLevel"] = getRadioValue(".otheritSkilledLevel");
  language["otheritDiploma"] = $("#otheritDiploma").val();

  language["otherFlag"] = mini.get("otherFlag").getValue();
  language["otherSkilledLevel"] = getRadioValue(".otherSkilledLevel");
  language["otherDiploma"] = $("#otherDiploma").val();
  return language;
}

//工作履历
function getWorkData(){
  var works = new Array();
  for(var i = 1; i <= wkcount; i++) {
    var stratdate =  mini.get("workstartdate"+i).getFormValue();
    if(stratdate != ''){
      var work = new Object();
      work["jobStartDate"] = mini.get("workstartdate"+i).getFormValue();
      work["jobEndDate"] = mini.get("workenddate"+i).getFormValue();
      work["companyName"] = $("#companyName"+i).val();
      work["salary"] = $("#finalSalary"+i).val();
      work["department"] = $("#department"+i).val();
      work["positionName"] = $("#finalPosition"+i).val();
      work["debriefer"] = $("#reportTo"+i).val();
      work["subordinate"] = $("#subordinates"+i).val();
      work["seniority"] = $("#seniority"+i).val();
      work["jobDuty"] = $("#responsibilities"+i).val();
      work["leaveReason"] = $("#leaveReason"+i).val();
      work["reterence"] = $("#reterence"+i).val();
      work["relationship"] = $("#relationship"+i).val();
      work["reterencePhone"] = $("#reterencePhone"+i).val();
      works.push(work);
    }
  }
  return works;
}

//奖励及特长
function getRewardData(){
  var reward = new Object();
  for(var i = 1; i <= 3; i++) {
    reward["rewardName"+i] = $("#rewardName"+i).val();
    reward["rewardDate"+i] = mini.get("rewardDate"+i).getFormValue();
    reward["authorities"+i] = $("#authorities"+i).val();
  }
  reward["hobby"] = $("#hobby").val();
  reward["speciality"] = $("#speciality").val();
  return reward;
}

//推荐人
function getRecommendedData(){
  return  mini.get("datagrid-recommended").getData(true);
}

//声明
function getIllustrateData(){
  var illustrate = new Object();
  illustrate["id"] = $("#infectionId").val();
  illustrate["infectionFlag"] = mini.get("infectionFlag").getValue();
  illustrate["infectionText"] = $("#infectionText").val();

  illustrate["criminalFlag"] = mini.get("criminalFlag").getValue();
  illustrate["criminalText"] = $("#criminalText").val();
  
  illustrate["employFlag"] = mini.get("employFlag").getValue();
  illustrate["employText"] = $("#employText").val();
  
  illustrate["investigateFlag"] = mini.get("investigateFlag").getValue();
  illustrate["investigateText"] = $("#investigateText").val();
  
  illustrate["banFlag"] = mini.get("banFlag").getValue();
  illustrate["banStartdate"] = mini.get("banStartdate").getFormValue();
  illustrate["banEnddate"] = mini.get("banEnddate").getFormValue();
  illustrate["payment"] = $("#payment").val();
  
  return illustrate;
}

//保存为草稿
$("#saveData").click(function() {
  //    var baseDate = JSON.stringify(getEducationData());
    //    alert(baseDate);
    mini.confirm("请确认姓名拼音是否正确？", "确定?", function (action) {
    	 if (action == "ok") {
    		 baseInfoSave("0");
    	 }
    })
      //baseInfoSave("0");
});
//发布
$("#release").click(function() {
  //    var baseDate = JSON.stringify(getEducationData());
    //    alert(baseDate);
    mini.confirm("请确认姓名拼音是否正确？", "确定?", function (action) {
   	 if (action == "ok") {
   		baseInfoSave("1");
   	 }
   })
      //baseInfoSave("1");
});

//数据保存
function baseInfoSave(fn) {
  var baseInfo=getBaseData();
  baseInfo["interviewStatus"]=fn;
    $.ajax({
        type : "post",
        async : false,
        dataType : "json",
        data : {"baseInfo" : JSON.stringify(baseInfo),
                "family" : getFamilyData(),
                "emergent" : JSON.stringify(getEmergentData()),
                "education" : JSON.stringify(getEducationData()),
                "certification" : JSON.stringify(getCertificationData()),
                "language" : JSON.stringify(getLanguageData()),
                "work" : JSON.stringify(getWorkData()),
                "reward" : JSON.stringify(getRewardData()),
                "recommended" : JSON.stringify(getRecommendedData()),
                "illustrate" : JSON.stringify(getIllustrateData())
        },
        url : basePath + "/interviewController/save",
        success : function(data){
            if(data.success){
              alert("保存成功！");
              window.location.href = basePath + "/interviewController/toInterview";
            }else{
              alert(data.msg);
            }
        },
        error: function() {
            $(".page-loading").hide();
            alert("保存失败!");
        }
    });
}

