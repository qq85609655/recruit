<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:aop="http://www.springframework.org/schema/aop" xmlns:context="http://www.springframework.org/schema/context"
  xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
       http://www.springframework.org/schema/aop
       http://www.springframework.org/schema/aop/spring-aop-4.0.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context-4.0.xsd">

  <!-- propertyPlaceHolderConfigurer和springPropertyResourceReader在SpringTestContextConfig中注册 -->

  <bean id="passwordHelper" class="org.amberframework.web.system.auth.service.impl.user.PasswordHelper">
    <property name="algorithmName" value="md5" />
    <property name="hashIterations" value="2" />
  </bean>
  
  <!-- Excel导出类，使用excelExportManager加载配置导出excel -->
  <bean id="excelExportManager" class="org.amberframework.core.excel.poi.DefaultExcelExportManager">
    <property name="excelExportService" ref="excelExportService" />
  </bean>
  <bean id="excelDataAnchorHandler" class="org.amberframework.core.excel.poi.anchor.DefaultExcelDataAnchorHandler">
  </bean>
  <bean id="excelExportService" class="org.amberframework.core.excel.poi.StandardExcelExportService">
    <property name="excelDataAnchorHandler" ref="excelDataAnchorHandler" />
  </bean>
  
  <!-- 构建http client连接池和用于调用REST服务的RestTemplate -->
  <bean id="restPoolHttpClientConnectionManager" class="org.apache.http.impl.conn.PoolingHttpClientConnectionManager">
    <!--整个连接池的并发-->
    <property name="maxTotal" value="1000"/>
    <!--每个主机的并发-->
    <property name="defaultMaxPerRoute" value="1000"/>
  </bean>

  <bean id="restHttpClientBuilder" class="org.apache.http.impl.client.HttpClientBuilder" factory-method="create">
    <property name="connectionManager" ref="restPoolHttpClientConnectionManager"/>
    <!--开启重试-->
    <property name="retryHandler">
      <bean class="org.apache.http.impl.client.DefaultHttpRequestRetryHandler">
        <constructor-arg value="2"/>
        <constructor-arg value="true"/>
      </bean>
    </property>
    <property name="defaultHeaders">
      <list>
        <bean class="org.apache.http.message.BasicHeader">
          <constructor-arg value="User-Agent"/>
          <constructor-arg value="Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.16 Safari/537.36"/>
        </bean>
        <bean class="org.apache.http.message.BasicHeader">
          <constructor-arg value="Accept-Encoding"/>
          <constructor-arg value="gzip,deflate"/>
        </bean>
        <bean class="org.apache.http.message.BasicHeader">
          <constructor-arg value="Accept-Language"/>
          <constructor-arg value="zh-CN"/>
        </bean>
      </list>
    </property>
  </bean>

  <bean id="restHttpClient" factory-bean="restHttpClientBuilder" factory-method="build"/>

  <bean id="restClientHttpRequestFactory"
        class="org.springframework.http.client.HttpComponentsClientHttpRequestFactory">
    <constructor-arg ref="restHttpClient"/>
    <!--连接超时时间，毫秒-->
    <property name="connectTimeout" value="300000"/>
    <!--读写超时时间，毫秒-->
    <property name="readTimeout" value="300000"/>
  </bean>

  <bean id="restTemplate" class="org.springframework.web.client.RestTemplate">
    <constructor-arg ref="restClientHttpRequestFactory"/>
    <property name="errorHandler">
      <bean class="org.springframework.web.client.DefaultResponseErrorHandler"/>
    </property>
    <property name="messageConverters">
      <list>
        <bean class="org.springframework.http.converter.ByteArrayHttpMessageConverter"/>
        <bean class="org.springframework.http.converter.FormHttpMessageConverter"/>
        <bean class="org.springframework.http.converter.json.MappingJackson2HttpMessageConverter">
          <property name="objectMapper">
            <bean class="com.fasterxml.jackson.databind.ObjectMapper">
              <property name="dateFormat">
                <bean class="java.text.SimpleDateFormat">
                  <constructor-arg type="java.lang.String" value="yyyy-MM-dd'T'HH:mm:ss" />
                </bean>
              </property>
            </bean>
          </property>
        </bean>
        <bean class="org.springframework.http.converter.StringHttpMessageConverter">
          <property name="supportedMediaTypes">
            <list>
              <value>text/plain;charset=UTF-8</value>
            </list>
          </property>
        </bean>
      </list>
    </property>
  </bean>
  <!-- End of 构建http client连接池和用于调用REST服务的RestTemplate -->

  <import resource="test-spring-context-scan.xml" />
  <import resource="test-spring-mybatis.xml" />
  <import resource="test-spring-cache.xml" />
  <import resource="test-spring-shiro.xml" />
</beans>